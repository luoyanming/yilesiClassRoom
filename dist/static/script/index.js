/**
 * @author luoym
 * @email 13575458746@163.com
 * @descrip 
 * @version v1.0.0
 */
var that,ws=null,INDEX={init:function(){localStorage.setItem("sid",""),localStorage.setItem("token",""),localStorage.removeItem("picUrl"),localStorage.removeItem("answerType"),localStorage.removeItem("isAnswer"),that=this,that.heartCount=0,that.UIInit(),that.webSocketInit()},UIInit:function(){that.flag="class",that.$qrcode=$("#qrcode"),that.$loading=$("#loading"),that.$reload=$("#reload"),that.$buttonReload=$("#button-reload"),that.$buttonClass=$("#button-class"),that.$buttonLesson=$("#button-lesson"),that.$textClass=$("#text-class"),that.$textLesson=$("#text-lesson"),that.buttonBind()},webSocketInit:function(){that.$qrcode.hide(),that.$loading.fadeIn(200),that.$reload.hide(),"WebSocket"in window?ws=new WebSocket("ws://"+CONFIG.online):alert("当前浏览器不支持 webSocket, 请更换最新版谷歌浏览器！"),ws.onerror=function(){console.log("WebSocket连接发生错误"),that.$qrcode.fadeOut(200),that.$loading.fadeOut(200),that.$reload.fadeIn(200)},ws.onopen=function(){console.log("WebSocket连接成功"),that.sendHeartMsg(),that.sendMsg({bizType:1e4,data:{}})},ws.onmessage=function(t){that.doReceiveMsg(t.data)},ws.onclose=function(){console.log("WebSocket连接关闭"),that.$qrcode.fadeOut(200),that.$loading.fadeOut(200),that.$reload.fadeIn(200)},window.onbeforeunload=function(){ws.close()}},sendHeartMsg:function(){setInterval(function(){that.heartCount<3?that.sendMsg({bizType:10006,data:{}}):location.href=location.href},5e3)},doReceiveMsg:function(t){if(t=JSON.parse(t),console.log(t),1e4==t.code){var e=new Image;e.src=t.data.qrCodeUrl,e.onload=function(){that.$qrcode.attr("src",t.data.qrCodeUrl).fadeIn(200),that.$loading.fadeOut(200),"lesson"==that.getQueryString("from")&&(that.$buttonLesson.fadeOut(200),that.$buttonClass.fadeIn(200),that.$textClass.parent().addClass("text-box-active"),that.flag="lesson")}}else 10001==t.code?that.sendMsg({bizType:10001,data:{}}):10006==t.code?that.heartCount-=1:80001==t.code&&(localStorage.setItem("sid",t.data.sid),localStorage.setItem("token",t.data.token),"class"==that.flag?location.href="./course.html":"lesson"==that.flag&&(location.href="./lesson.html"))},sendMsg:function(t){ws.send(JSON.stringify(t))},buttonBind:function(){that.$buttonReload.on("click",function(){that.webSocketInit()}),that.$buttonClass.on("click",function(){that.$buttonLesson.fadeIn(200),that.$buttonClass.fadeOut(200),that.$textClass.parent().removeClass("text-box-active"),that.flag="class",that.relaodQrcodeImg()}),that.$buttonLesson.on("click",function(){that.$buttonLesson.fadeOut(200),that.$buttonClass.fadeIn(200),that.$textClass.parent().addClass("text-box-active"),that.flag="lesson",that.relaodQrcodeImg()})},relaodQrcodeImg:function(){that.$qrcode.fadeOut(200),that.$loading.fadeIn(200);var t=setTimeout(function(){that.$qrcode.fadeIn(200),that.$loading.fadeOut(200),clearTimeout(t)},1e3)},getQueryString:function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):null}};INDEX.init();