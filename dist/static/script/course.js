/**
 * @author luoym
 * @email 13575458746@163.com
 * @descrip 
 * @version v1.0.0
 */
var that,ws=null,INDEX={init:function(){""==document.referrer&&(localStorage.setItem("sid",""),localStorage.setItem("token",""),localStorage.removeItem("picUrl"),localStorage.removeItem("answerType"),localStorage.removeItem("isAnswer"),localStorage.removeItem("canvasData")),that=this,that.UIInit(),that.$connection.hide(),that.$screen.hide(),that.showLoading("正在连接易乐思课堂..."),that.sid=localStorage.getItem("sid"),that.token=localStorage.getItem("token"),that.sid&&that.token?that.webSocketInit():location.href="./index.html",that.heartCount=0,$(window).unbind("resize"),$(window).on("resize",function(){location.href=location.href})},UIInit:function(){that.$course=$("#course"),that.$connection=$("#connection"),that.$loading=$("#loading"),that.$screen=$("#screen"),that.$courseImg=$("#courseImg"),that.$toolbar=$("#toolbar"),that.$buttonRefresh=$("#button-refresh"),that.$buttonFullscreen=$("#button-fullscreen"),that.$bindcard=$("#bindcard"),that.$bindlist=$("#bindlist"),that.$buttonRefresh.unbind("click"),that.$buttonRefresh.on("click",that.buttonRefreshBind),that.$buttonFullscreen.unbind("click"),that.$buttonFullscreen.on("click",that.buttonFullscreenBind)},webSocketInit:function(){"WebSocket"in window?ws=new WebSocket("ws://"+CONFIG.online):alert("当前浏览器不支持 webSocket, 请更换最新版谷歌浏览器！"),ws.onopen=function(){console.log("WebSocket连接成功"),that.sendHeartMsg(),that.sendMsg({bizType:10002,sid:that.sid,token:that.token,data:{loginType:2}})},ws.onmessage=function(t){that.doReceiveMsg(t.data)},ws.onclose=function(){console.log("WebSocket连接关闭"),ws.close(),ws=null,that.$screen.hide(),that.showLoading("连接已断开，正在重新连接，请稍候"),that.webSocketInit()},window.onbeforeunload=function(){that.sendMsg({bizType:10011,sid:that.sid,token:that.token,data:{opType:1001101}}),ws.close()}},sendHeartMsg:function(){setInterval(function(){that.heartCount<3?that.sendMsg({bizType:10006,data:{}}):location.href=location.href},5e3)},doReceiveMsg:function(t){if(t=JSON.parse(t),console.log(t),-1==t.code);else if(10001==t.code)that.sendMsg({bizType:10001,data:{}});else if(10002==t.code)localStorage.getItem("picUrl")?that.showImage(localStorage.getItem("picUrl"),localStorage.getItem("answerType"),localStorage.getItem("isAnswer")):(that.$connection.fadeIn(200),that.$screen.fadeIn(200),that.$loading.fadeOut(200));else if(10006==t.code)that.heartCount-=1;else if(10007==t.code)ws.close(),alert("您的账号已在其它地点登录，将被强制下线！"),location.href="./index.html";else if(80002==t.code)localStorage.removeItem("picUrl"),localStorage.removeItem("answerType"),localStorage.removeItem("isAnswer"),localStorage.removeItem("canvasData"),that.$connection.fadeIn(200),that.$screen.find("#canvas").remove(),that.$screen.find(".state-before").remove(),that.$screen.find(".state-doing").remove(),that.$screen.find(".state-after").remove(),that.$screen.find(".state-chart").remove(),that.$screen.find(".state-student").remove(),that.$courseImg.hide(),that.$screen.fadeIn(200),that.$loading.fadeOut(200);else if(80003==t.code)t.data.picList?that.showImage(t.data.picUrl,t.data.answerType,t.data.isAnswer,t.data.picList):that.showImage(t.data.picUrl,t.data.answerType,t.data.isAnswer);else if(80004==t.code){that.$screen.find(".state-before").remove(),that.$screen.find(".state-after").remove(),that.$screen.find(".chart").remove();var e="";e+='<div class="state-doing">',e+='<p class="text text-time">答题时间：00:00:00</p>',e+='<p class="text text-number">答题人数：0人</p>',e+='<div class="button-stop">结束答题</div>',e+="</div>",that.$screen.append(e),that.timeClock()}else if(80005==t.code){var e="";e+='<div class="state-after">',e+='<div class="button-detail">查看结果</div>',e+='<p class="text">重新答题</p>',e+="</div>",clearInterval(that.XF),that.$screen.find(".state-doing").remove(),that.$screen.append(e)}else if(80006==t.code){var a=t.data.answerInfo,n=[],o=[];if(3==a.answerType)n=["✓","✕","未答题"],o=[{value:a.numTrue,width:"",bgcolor:"#38A0FF"},{value:a.numFalse,width:"",bgcolor:"#FFFD38"},{value:a.giveupNum,width:"",bgcolor:"#D9D9D9"}],"0"==a.answer||0==a.answer?o[1].bgcolor="#1EC51D":"1"!=a.answer&&1!=a.answer||(o[0].bgcolor="#1EC51D");else if(1==a.answerType){n=["A","B","C","D","E","F","未答题"],o=[{value:a.numA,width:"",bgcolor:"#38A0FF"},{value:a.numB,width:"",bgcolor:"#FFFD38"},{value:a.numC,width:"",bgcolor:"#D71616"},{value:a.numD,width:"",bgcolor:"#D68A16"},{value:a.numE,width:"",bgcolor:"#7A38FF"},{value:a.numF,width:"",bgcolor:"#C238FF"},{value:a.giveupNum,width:"",bgcolor:"#D9D9D9"}];var i=n.indexOf(a.answer);o[i].bgcolor="#1EC51D"}else 2==a.answerType&&(n=["A","B","C","D","E","F","答对","未答题"],o=[{value:a.numA,width:"",bgcolor:"#38A0FF"},{value:a.numB,width:"",bgcolor:"#FFFD38"},{value:a.numC,width:"",bgcolor:"#D71616"},{value:a.numD,width:"",bgcolor:"#D68A16"},{value:a.numE,width:"",bgcolor:"#7A38FF"},{value:a.numF,width:"",bgcolor:"#C238FF"},{value:a.rightNum,width:"",bgcolor:"#1EC51D"},{value:a.giveupNum,width:"",bgcolor:"#D9D9D9"}]);for(var s=[],r=0;r<o.length;r++)s.push(o[r].value);s.sort(that.compare);for(var c=s.pop(),l=0;l<o.length;l++)o[l].width=parseInt(o[l].value)/parseInt(c)*90;var e="";e+='<div class="chart">',e+='<div class="chart-box flex-h">',e+='<div class="time">答题时间：00:'+that.transMinute(Math.floor(a.costTime/60))+":"+that.transSecond(a.costTime%60)+"</div>",e+='<div class="titles">';for(var d=0;d<n.length;d++)e+='<p class="titles-item">'+n[d]+"</p>";e+="</div>",e+='<div class="options flex-a-i">';for(var h=0;h<o.length;h++)e+='<div class="options-item flex-h">',e+='<p class="color-line" style="width: '+o[h].width+"%; background: "+o[h].bgcolor+';"></p>',e+='<p class="text">'+o[h].value+"人</p>",e+="</div>";e+="</div>",e+="</div>",e+="</div>",that.$screen.find(".state-after").fadeOut(200),that.$screen.append(e)}else if(80007==t.code){that.$screen.find(".student").remove();var u="";switch(parseInt(t.data.answerType)){case 0:u="选择✕的学生";break;case 1:u="选择✓的学生";break;case 2:u="答对("+t.data.rightAnswer+")的学生";break;case 4:u="未答题的学生";break;default:u="选择"+t.data.answerType+"的学生"}var e="";e+='<div class="student">',e+='<div class="student-box">',e+="<h2>"+u+"</h2>";for(var l=0;l<t.data.studentList.length;l++)e+="<p>"+t.data.studentList[l].name+"</p>";e+="</div>",e+="</div>",that.$screen.find(".chart").hide(),that.$screen.append(e)}else if(80008==t.code)that.$screen.find(".state-doing .text-number").html("答题人数："+t.data.answerNum+"人");else if(80009==t.code)that.$screen.find(".chart").hide(),that.$screen.find(".state-after").fadeIn(200);else if(80010==t.code)that.$screen.find(".student").hide(),that.$screen.find(".chart").fadeIn(200);else if(80011==t.code)ws.close(),location.href="./index.html";else if(80013==t.code){var m=["A","B","C","D","E","F","","1","0"],g=t.data.code.split(""),f=that.$bindcard.find(".card-header .card-item"),v=that.$bindcard.find(".card-main .card-item");v.removeClass("selected");for(var l=0;l<g.length;l++){"0"==g[l]?f.eq(l).html("✕"):"1"==g[l]?f.eq(l).html("✓"):f.eq(l).html(g[l]);var i=m.indexOf(g[l]);v.eq(i).addClass("selected")}that.$bindcard.find(".card-info span").html(t.data.stuNum),that.$bindcard.show();var p=that.$bindcard.height(),b=that.$bindcard.find(".bindcard-box").height(),w=p/b;that.$bindcard.find(".bindcard-box").css({"-webkit-transform":"translate3d(-50%, -50%, 0) scale("+w+")","-moz-transform":"translate3d(-50%, -50%, 0) scale("+w+")","-ms-transform":"translate3d(-50%, -50%, 0) scale("+w+")",transform:"translate3d(-50%, -50%, 0) scale("+w+")"}),that.$connection.hide(),that.$bindlist.hide(),that.$bindcard.addClass("bindcard-active")}else if(80014==t.code){if(t.data.studentList&&t.data.studentList.length>0){for(var $="",l=0;l<t.data.studentList.length;l++)$+='<li class="list-item">'+t.data.studentList[l]+"</li>";that.$bindlist.find("ul").html($)}else that.$bindlist.find("ul").html('<li class="no-data">暂无绑定的学生</li>');that.$bindcard.removeClass("bindcard-active").hide(),that.$bindlist.fadeIn(300)}else if(80015==t.code)that.$bindcard.removeClass("bindcard-active").hide(),that.$bindlist.hide(),that.$connection.fadeIn(300);else if(80016==t.code)that.$bindcard.find(".card-info span").html(t.data.stuNum);else if(80017==t.code){var I=[];if(localStorage.getItem("canvasData")){I=JSON.parse(localStorage.getItem("canvasData"));for(var l=0;l<I.length;l++)if(I[l].picUrl==localStorage.getItem("picUrl"))return void that.canvasInit()}else I=[];I.push({picUrl:localStorage.getItem("picUrl"),data:{width:t.data.initData.width,height:t.data.initData.height}}),localStorage.setItem("canvasData",JSON.stringify(I)),that.canvasInit()}else if(80018==t.code)for(var I=JSON.parse(localStorage.getItem("canvasData")),S=t.data.points[0],F=localStorage.getItem("picUrl"),l=0;l<I.length;l++)if(I[l].picUrl==F){var k=I[l].data;if(k.lines){for(var d=0;d<k.lines.length;d++)if(k.lines[d].lineId==S.lineId)return k.lines[d].location||(k.lines[d].location=[]),k.lines[d].location.push({x:S.x,y:S.y}),localStorage.setItem("canvasData",JSON.stringify(I)),void that.drawCanvas();return k.lines.push({lineId:S.lineId,color:S.color,isEraser:S.isEraser,location:[{x:S.x,y:S.y}]}),localStorage.setItem("canvasData",JSON.stringify(I)),void that.drawCanvas()}return k.lines=[],k.lines.push({lineId:S.lineId,color:S.color,isEraser:S.isEraser,location:[{x:S.x,y:S.y}]}),localStorage.setItem("canvasData",JSON.stringify(I)),void that.drawCanvas()}},sendMsg:function(t){ws.send(JSON.stringify(t))},showImage:function(t,e,a,n){if(localStorage.setItem("picUrl",t),localStorage.setItem("answerType",e),localStorage.setItem("isAnswer",a?"true":""),that.$connection.hide(),that.$screen.hide(),that.$courseImg.hide(),that.showLoading("正在同步显示手机屏幕，请稍候"),that.$screen.find("#canvas").remove(),that.$screen.find(".state-before").remove(),that.$screen.find(".state-doing").remove(),that.$screen.find(".state-after").remove(),that.$screen.find(".state-chart").remove(),that.$screen.find(".state-student").remove(),0!=(e=parseInt(e)))if(localStorage.getItem("isAnswer")){var o="";o+='<div class="state-after">',o+='<div class="button-detail">查看结果</div>',o+='<p class="text">重新答题</p>',o+="</div>",that.$screen.append(o)}else switch(e){case 1:that.$screen.append('<div class="state-before">答题(单选)</div>');break;case 2:that.$screen.append('<div class="state-before">答题(多选)</div>');break;case 3:that.$screen.append('<div class="state-before">答题(判断)</div>');break;default:that.$screen.append("")}var i=new Image;i.src=t,pageWidth=window.innerWidth,pageHeight=window.innerHeight-42,"number"!=typeof pageWidth&&("CSS1Compat"==document.compatMode?(pageWidth=document.documentElement.clientWidth,pageHeight=document.documentElement.clientHeight-42):(pageWidth=document.body.clientWidth,pageHeight=document.body.clientHeight-42));var s=pageWidth/pageHeight;i.onload=function(){i.width/i.height>s?that.$courseImg.css({width:"100%",height:"auto"}):that.$courseImg.css({height:"100%",width:"auto"}),that.$loading.fadeOut(200),that.$courseImg.attr("src",t).show(),that.$screen.fadeIn(200),that.canvasInit(),n&&that.preloadImages(n)}},showLoading:function(t){that.$loading.find(".text").html(t),that.$loading.fadeIn(200)},timeClock:function(){that.clock=0,that.seconds=0,that.minutes=0,that.XF=setInterval(function(){that.clock+=1,that.seconds=that.clock%60,that.minutes=Math.floor(that.clock/60),that.$screen.find(".state-doing .text-time").html("答题时间：00:"+that.transMinute(that.minutes)+":"+that.transSecond(that.seconds))},1e3)},preloadImages:function(t){for(var e=[],a=0;a<t.length;a++)e[a]=new Image,e[a].src=t[a]},canvasInit:function(){var t=(localStorage.getItem("picUrl"),JSON.parse(localStorage.getItem("canvasData")));if(!t)return!1;for(var e=0;e<t.length;e++)if(t[e].picUrl==localStorage.getItem("picUrl")){var a=t[e].data,n=a.width,o=a.height,i=window.innerWidth,s=window.innerHeight-42;"number"!=typeof i&&("CSS1Compat"==document.compatMode?(i=document.documentElement.clientWidth,s=document.documentElement.clientHeight-42):(i=document.body.clientWidth,s=document.body.clientHeight-42));var r,c=i/s,l=$("#courseImg").width(),d=$("#courseImg").height(),h=l/d;return h>c?(r=i/n,n=i,o*=r):(r=s/o,n*=r,o=s),localStorage.setItem("scale",r),void that.createCanvas(n,o)}},createCanvas:function(t,e){$(".canvas").html('<canvas id="canvas" width="'+t+'" height="'+e+'"></canvas>'),that.drawCanvas()},drawCanvas:function(){var t=(localStorage.getItem("picUrl"),JSON.parse(localStorage.getItem("canvasData"))),e=document.getElementById("canvas"),a=e.getContext("2d");a.clearRect(0,0,$("#canvas").width(),$("#canvas").height());for(var n=0;n<t.length;n++)if(t[n].picUrl==localStorage.getItem("picUrl")){var o=t[n].data.lines,i=localStorage.getItem("scale");if(!o)return!1;a.lineCap="round",a.lineJoin="round";for(var s=0;s<o.length;s++){var r=o[s].color,c=o[s].isEraser,l=o[s].location;"-2681322"==r?r="#D71616":"-13065985"==r&&(r="#38A0FF"),c?(a.globalCompositeOperation="destination-out",a.lineWidth=40*parseFloat(localStorage.getItem("scale"))):(a.globalCompositeOperation="source-over",a.lineWidth=4*parseFloat(localStorage.getItem("scale"))),a.beginPath(),a.strokeStyle=r;for(var d=0;d<l.length-1;d++)a.moveTo(parseFloat(l[d].x)*i,parseFloat(l[d].y)*i),a.lineTo(parseFloat(l[d+1].x)*i,parseFloat(l[d+1].y)*i);a.closePath(),a.stroke()}return}},transMinute:function(t){return t<10?"0"+t:t},transSecond:function(t){return t<10?"0"+t:t},compare:function(t,e){return t<e?-1:t>e?1:0},buttonRefreshBind:function(){location.href=location.href},buttonFullscreenBind:function(){"true"==that.$buttonFullscreen.attr("data-fullscreen")?that.cancleFullscreen():(that.launchFullscreen(document.documentElement),that.$buttonFullscreen.attr("data-fullscreen","true"))},launchFullscreen:function(t){t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen(),that.$buttonFullscreen.attr("data-fullscreen","true")},cancleFullscreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),that.$buttonFullscreen.attr("data-fullscreen","false")}};INDEX.init();