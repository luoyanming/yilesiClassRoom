/**
 * @author luoym
 * @email 13575458746@163.com
 * @descrip 
 * @version v1.0.0
 */
var that,ws=null,INDEX={init:function(){""==document.referrer&&(localStorage.setItem("sid",""),localStorage.setItem("token",""),localStorage.removeItem("picUrl"),localStorage.removeItem("answerType"),localStorage.removeItem("isAnswer")),that=this,that.UIInit(),that.$connection.hide(),that.$screen.hide(),that.showLoading("正在连接易乐思课堂..."),that.sid=localStorage.getItem("sid"),that.token=localStorage.getItem("token"),that.sid&&that.token?that.webSocketInit():location.href="./index.html",that.heartCount=0},UIInit:function(){that.$course=$("#course"),that.$connection=$("#connection"),that.$loading=$("#loading"),that.$screen=$("#screen"),that.$courseImg=$("#courseImg"),that.$toolbar=$("#toolbar"),that.$buttonRefresh=$("#button-refresh"),that.$buttonFullscreen=$("#button-fullscreen"),that.$bindcard=$("#bindcard"),that.$bindlist=$("#bindlist"),that.$buttonRefresh.unbind("click"),that.$buttonRefresh.on("click",that.buttonRefreshBind),that.$buttonFullscreen.unbind("click"),that.$buttonFullscreen.on("click",that.buttonFullscreenBind)},webSocketInit:function(){"WebSocket"in window?ws=new WebSocket("ws://"+CONFIG.online):alert("当前浏览器不支持 webSocket, 请更换最新版谷歌浏览器！"),ws.onopen=function(){console.log("WebSocket连接成功"),that.sendHeartMsg(),that.sendMsg({bizType:10002,sid:that.sid,token:that.token,data:{loginType:2}})},ws.onmessage=function(t){that.doReceiveMsg(t.data)},ws.onclose=function(){console.log("WebSocket连接关闭"),ws.close(),ws=null,that.$screen.hide(),that.showLoading("连接已断开，正在重新连接，请稍候"),that.webSocketInit()},window.onbeforeunload=function(){ws.close()}},sendHeartMsg:function(){setInterval(function(){that.heartCount<3?that.sendMsg({bizType:10006,data:{}}):location.href=location.href},5e3)},doReceiveMsg:function(t){if(t=JSON.parse(t),console.log(t),-1==t.code);else if(10001==t.code)that.sendMsg({bizType:10001,data:{}});else if(10002==t.code)localStorage.getItem("picUrl")?that.showImage(localStorage.getItem("picUrl"),localStorage.getItem("answerType"),localStorage.getItem("isAnswer")):(that.$connection.fadeIn(200),that.$screen.fadeIn(200),that.$loading.fadeOut(200));else if(10006==t.code)that.heartCount-=1;else if(10007==t.code)ws.close(),alert("您的账号已在其它地点登录，将被强制下线！"),location.href="./index.html";else if(80002==t.code)localStorage.removeItem("picUrl"),localStorage.removeItem("answerType"),localStorage.removeItem("isAnswer"),that.$connection.fadeIn(200),that.$screen.find(".state-before").remove(),that.$screen.find(".state-doing").remove(),that.$screen.find(".state-after").remove(),that.$screen.find(".state-chart").remove(),that.$screen.find(".state-student").remove(),that.$courseImg.hide(),that.$screen.fadeIn(200),that.$loading.fadeOut(200);else if(80003==t.code)t.data.picList?that.showImage(t.data.picUrl,t.data.answerType,t.data.isAnswer,t.data.picList):that.showImage(t.data.picUrl,t.data.answerType,t.data.isAnswer);else if(80004==t.code){that.$screen.find(".state-before").remove(),that.$screen.find(".state-after").remove(),that.$screen.find(".chart").remove();var e="";e+='<div class="state-doing">',e+='<p class="text text-time">答题时间：00:00:00</p>',e+='<p class="text text-number">答题人数：0人</p>',e+='<div class="button-stop">结束答题</div>',e+="</div>",that.$screen.append(e),that.timeClock()}else if(80005==t.code){var e="";e+='<div class="state-after">',e+='<div class="button-detail">查看结果</div>',e+='<p class="text">重新答题</p>',e+="</div>",clearInterval(that.XF),that.$screen.find(".state-doing").remove(),that.$screen.append(e)}else if(80006==t.code){var a=t.data.answerInfo,n=[],s=[];3==a.answerType?(n=["&radic;","x","未答题"],s=[{value:a.numTrue,width:"",bgcolor:"#38A0FF"},{value:a.numFalse,width:"",bgcolor:"#1EC51D"},{value:a.giveupNum,width:"",bgcolor:"#D9D9D9"}]):1==a.answerType?(n=["A","B","C","D","E","F","未答题"],s=[{value:a.numA,width:"",bgcolor:"#38A0FF"},{value:a.numB,width:"",bgcolor:"#FFFD38"},{value:a.numC,width:"",bgcolor:"#D71616"},{value:a.numD,width:"",bgcolor:"#D68A16"},{value:a.numE,width:"",bgcolor:"#7A38FF"},{value:a.numF,width:"",bgcolor:"#C238FF"},{value:a.giveupNum,width:"",bgcolor:"#D9D9D9"}]):2==a.answerType&&(n=["A","B","C","D","E","F","答对","未答题"],s=[{value:a.numA,width:"",bgcolor:"#38A0FF"},{value:a.numB,width:"",bgcolor:"#FFFD38"},{value:a.numC,width:"",bgcolor:"#D71616"},{value:a.numD,width:"",bgcolor:"#D68A16"},{value:a.numE,width:"",bgcolor:"#7A38FF"},{value:a.numF,width:"",bgcolor:"#C238FF"},{value:a.rightNum,width:"",bgcolor:"#1EC51D"},{value:a.giveupNum,width:"",bgcolor:"#D9D9D9"}]);for(var o=[],i=0;i<s.length;i++)o.push(s[i].value);o.sort(that.compare);for(var c=o.pop(),r=0;r<s.length;r++)s[r].width=parseInt(s[r].value)/parseInt(c)*90;var e="";e+='<div class="chart">',e+='<div class="chart-box flex-h">',e+='<div class="time">答题时间：00:'+that.transMinute(Math.floor(a.costTime/60))+":"+that.transSecond(a.costTime%60)+"</div>",e+='<div class="titles">';for(var d=0;d<n.length;d++)e+='<p class="titles-item">'+n[d]+"</p>";e+="</div>",e+='<div class="options flex-a-i">';for(var l=0;l<s.length;l++)e+='<div class="options-item flex-h">',e+='<p class="color-line" style="width: '+s[l].width+"%; background: "+s[l].bgcolor+';"></p>',e+='<p class="text">'+s[l].value+"人</p>",e+="</div>";e+="</div>",e+="</div>",e+="</div>",that.$screen.find(".state-after").fadeOut(200),that.$screen.append(e)}else if(80007==t.code){that.$screen.find(".student").remove();var e="";e+='<div class="student">',e+='<div class="student-box">';for(var r=0;r<t.data.studentList.length;r++)e+="<p>"+t.data.studentList[r].name+"</p>";e+="</div>",e+="</div>",that.$screen.find(".chart").hide(),that.$screen.append(e)}else if(80008==t.code)that.$screen.find(".state-doing .text-number").html("答题人数："+t.data.answerNum+"人");else if(80009==t.code)that.$screen.find(".chart").hide(),that.$screen.find(".state-after").fadeIn(200);else if(80010==t.code)that.$screen.find(".student").hide(),that.$screen.find(".chart").fadeIn(200);else if(80011==t.code)ws.close(),location.href="./index.html";else if(80013==t.code){var h=["A","B","C","D","E","F","","1","0"],u=t.data.code.split(""),m=that.$bindcard.find(".card-header .card-item"),f=that.$bindcard.find(".card-main .card-item");f.removeClass("selected");for(var r=0;r<u.length;r++){"0"==u[r]?m.eq(r).html("X"):"1"==u[r]?m.eq(r).html("&radic;"):m.eq(r).html(u[r]);var g=h.indexOf(u[r]);f.eq(g).addClass("selected")}0==t.data.stuNum?that.$bindcard.find(".card-info span").html('<a href="javascript:void(0);">查看学生名单</a>'):that.$bindcard.find(".card-info span").html("已有<span>"+t.data.stuNum+'</span>名学生绑定成功！<a href="javascript:void(0);">查看学生名单</a>'),that.$bindcard.show();var v=that.$bindcard.height(),b=that.$bindcard.find(".bindcard-box").height(),$=v/b;that.$bindcard.find(".bindcard-box").css({"-webkit-transform":"translate3d(-50%, -50%, 0) scale("+$+")","-moz-transform":"translate3d(-50%, -50%, 0) scale("+$+")","-ms-transform":"translate3d(-50%, -50%, 0) scale("+$+")",transform:"translate3d(-50%, -50%, 0) scale("+$+")"}),that.$connection.hide(),that.$bindlist.hide(),that.$bindcard.addClass("bindcard-active")}else if(80014==t.code){if(t.data.studentList&&t.data.studentList.length>0){for(var p="",r=0;r<t.data.studentList.length;r++)p+='<li class="list-item">'+t.data.studentList[r]+"</li>";that.$bindlist.find("ul").html(p)}else that.$bindlist.find("ul").html('<li class="no-data">暂无绑定的学生</li>');that.$bindcard.removeClass("bindcard-active").hide(),that.$bindlist.fadeIn(300)}else 80015==t.code&&(that.$bindcard.removeClass("bindcard-active").hide(),that.$bindlist.hide(),that.$connection.fadeIn(300))},sendMsg:function(t){ws.send(JSON.stringify(t))},showImage:function(t,e,a,n){if(localStorage.setItem("picUrl",t),localStorage.setItem("answerType",e),localStorage.setItem("isAnswer",a?"true":""),that.$connection.hide(),that.$screen.hide(),that.$courseImg.hide(),that.showLoading("正在同步显示手机屏幕，请稍候"),that.$screen.find(".state-before").remove(),that.$screen.find(".state-doing").remove(),that.$screen.find(".state-after").remove(),that.$screen.find(".state-chart").remove(),that.$screen.find(".state-student").remove(),0!=(e=parseInt(e)))if(localStorage.getItem("isAnswer")){var s="";s+='<div class="state-after">',s+='<div class="button-detail">查看结果</div>',s+='<p class="text">重新答题</p>',s+="</div>",that.$screen.append(s)}else switch(e){case 1:that.$screen.append('<div class="state-before">答题(单选)</div>');break;case 2:that.$screen.append('<div class="state-before">答题(多选)</div>');break;case 3:that.$screen.append('<div class="state-before">答题(判断)</div>');break;default:that.$screen.append("")}var o=new Image;o.src=t,pageWidth=window.innerWidth,pageHeight=window.innerHeight,"number"!=typeof pageWidth&&("CSS1Compat"==document.compatMode?(pageWidth=document.documentElement.clientWidth,pageHeight=document.documentElement.clientHeight):(pageWidth=document.body.clientWidth,pageHeight=document.body.clientHeight));var i=pageWidth/pageHeight;o.onload=function(){o.width/o.height>i?that.$courseImg.css({width:"100%",height:"auto"}):that.$courseImg.css({height:"100%",width:"auto"}),that.$loading.fadeOut(200),that.$courseImg.attr("src",t).show(),that.$screen.fadeIn(200),n&&that.preloadImages(n)}},showLoading:function(t){that.$loading.find(".text").html(t),that.$loading.fadeIn(200)},timeClock:function(){that.clock=0,that.seconds=0,that.minutes=0,that.XF=setInterval(function(){that.clock+=1,that.seconds=that.clock%60,that.minutes=Math.floor(that.clock/60),that.$screen.find(".state-doing .text-time").html("答题时间：00:"+that.transMinute(that.minutes)+":"+that.transSecond(that.seconds))},1e3)},preloadImages:function(t){for(var e=[],a=0;a<t.length;a++)e[a]=new Image,e[a].src=t[a]},transMinute:function(t){return t<10?"0"+t:t},transSecond:function(t){return t<10?"0"+t:t},compare:function(t,e){return t<e?-1:t>e?1:0},buttonRefreshBind:function(){location.href=location.href},buttonFullscreenBind:function(){"true"==that.$buttonFullscreen.attr("data-fullscreen")?that.cancleFullscreen():(that.launchFullscreen(document.documentElement),that.$buttonFullscreen.attr("data-fullscreen","true"))},launchFullscreen:function(t){t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen(),that.$buttonFullscreen.attr("data-fullscreen","true")},cancleFullscreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),that.$buttonFullscreen.attr("data-fullscreen","false")}};INDEX.init();