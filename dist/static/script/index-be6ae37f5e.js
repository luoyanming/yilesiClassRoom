/**
 * @author luoym
 * @email 13575458746@163.com
 * @descrip 
 * @version v1.0.0
 */
var that,ws=null,INDEX={init:function(){localStorage.setItem("sid",""),localStorage.setItem("token",""),localStorage.removeItem("sessionType"),localStorage.removeItem("picUrl"),localStorage.removeItem("answerType"),localStorage.removeItem("isAnswer"),localStorage.removeItem("timeClock"),localStorage.removeItem("answerNum"),localStorage.removeItem("answerCharts"),localStorage.removeItem("answerStudent"),localStorage.removeItem("bindcardData"),localStorage.removeItem("bindStudentData"),localStorage.removeItem("canvasData"),that=this,that.heartCount=0,that.UIInit()},UIInit:function(){that.$qrcodeClass=$("#qrcode-class"),that.$qrcodeLesson=$("#qrcode-lesson"),that.$qrcodeMaskClass=$("#qrcode-mask-class"),that.$qrcodeMaskLesson=$("#qrcode-mask-lesson"),that.$loading=$("#loading"),that.$reload=$("#reload"),that.$buttonReload=$("#button-reload"),that.$buttonClass=$("#button-class"),that.$buttonLesson=$("#button-lesson"),that.$textClass=$("#text-class"),that.$textLesson=$("#text-lesson"),that.$buttonDownload=$("#button-download"),that.$buttonDownloadClose=$("#button-download-close"),that.$downloadModal=$("#modal-download"),"lesson"==that.getQueryString("from")?that.flag="lesson":that.flag="class","class"==that.flag?(that.$buttonLesson.fadeIn(200),that.$buttonClass.fadeOut(200),that.$textClass.parent().removeClass("text-box-active")):"lesson"==that.flag&&(that.$buttonLesson.fadeOut(200),that.$buttonClass.fadeIn(200),that.$textClass.parent().addClass("text-box-active")),that.buttonBind(),that.webSocketInit()},webSocketInit:function(){that.$qrcodeClass.hide(),that.$qrcodeLesson.hide(),that.$loading.fadeIn(200),that.$reload.hide(),"WebSocket"in window?ws=new WebSocket("ws://"+CONFIG.online):alert("当前浏览器不支持 webSocket, 请更换最新版谷歌浏览器！"),ws.onerror=function(){console.log("WebSocket连接发生错误"),that.$qrcodeClass.fadeOut(200),that.$qrcodeLesson.fadeOut(200),that.$qrcodeMaskClass.fadeOut(200),that.$qrcodeMaskLesson.fadeOut(200),that.$loading.fadeOut(200),that.$reload.fadeIn(200)},ws.onopen=function(){console.log("WebSocket连接成功"),that.sendHeartMsg(),"class"==that.flag?that.sendMsg({bizType:1e4,data:{loginType:1}}):"lesson"==that.flag&&that.sendMsg({bizType:1e4,data:{loginType:2}})},ws.onmessage=function(t){that.doReceiveMsg(t.data)},ws.onclose=function(){console.log("WebSocket连接关闭"),that.$qrcodeClass.fadeOut(200),that.$qrcodeLesson.fadeOut(200),that.$qrcodeMaskClass.fadeOut(200),that.$qrcodeMaskLesson.fadeOut(200),that.$loading.fadeOut(200),that.$reload.fadeIn(200)},window.onbeforeunload=function(){ws.close()}},sendHeartMsg:function(){setInterval(function(){that.heartCount<3?that.sendMsg({bizType:10006,data:{}}):location.href=location.href},5e3)},doReceiveMsg:function(t){if(t=JSON.parse(t),console.log(t),1e4==t.code){var a=new Image;a.src=t.data.qrCodeUrl,a.onload=function(){"class"==that.flag?(that.$qrcodeClass.attr("src",t.data.qrCodeUrl).fadeIn(200),that.$qrcodeMaskClass.fadeIn(200)):(that.$qrcodeLesson.attr("src",t.data.qrCodeUrl).fadeIn(200),that.$qrcodeMaskLesson.fadeIn(200)),that.$loading.fadeOut(200)}}else 10001==t.code?that.sendMsg({bizType:10001,data:{}}):10006==t.code?that.heartCount-=1:80001==t.code&&(localStorage.setItem("sid",t.data.sid),localStorage.setItem("token",t.data.token),"class"==that.flag?location.href="./course.html":"lesson"==that.flag&&(location.href="./lesson.html"))},sendMsg:function(t){ws.send(JSON.stringify(t))},buttonBind:function(){that.$buttonReload.on("click",function(){that.webSocketInit()}),that.$buttonClass.on("click",function(){that.$buttonLesson.fadeIn(200),that.$buttonClass.fadeOut(200),that.$textClass.parent().removeClass("text-box-active"),that.flag="class",that.$qrcodeLesson.fadeOut(200),that.$qrcodeMaskLesson.fadeOut(200),that.$qrcodeClass.attr("src")?(that.$qrcodeClass.fadeIn(200),that.$qrcodeMaskClass.fadeIn(200)):(that.$loading.fadeIn(200),that.sendMsg({bizType:1e4,data:{loginType:1}}))}),that.$buttonLesson.on("click",function(){that.$buttonLesson.fadeOut(200),that.$buttonClass.fadeIn(200),that.$textClass.parent().addClass("text-box-active"),that.flag="lesson",that.$qrcodeClass.fadeOut(200),that.$qrcodeMaskClass.fadeOut(200),that.$qrcodeLesson.attr("src")?(that.$qrcodeLesson.fadeIn(200),that.$qrcodeMaskLesson.fadeIn(200)):(that.$loading.fadeIn(200),that.sendMsg({bizType:1e4,data:{loginType:2}}))}),that.$buttonDownload.on("click",function(){that.$downloadModal.toggle()}),that.$buttonDownloadClose.on("click",function(){that.$downloadModal.toggle()})},getQueryString:function(t){var a=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),e=window.location.search.substr(1).match(a);return null!=e?unescape(e[2]):null}};INDEX.init();